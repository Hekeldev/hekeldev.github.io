<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Mp3Player</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen">

  <div class="bg-gray-800 p-6 rounded-2xl w-[90vw] max-w-md shadow-lg text-base">
    
    <h1 class="text-2xl font-bold mb-4 text-center">ðŸŽµ Music Player</h1>

    <!-- Audio Player -->
    <audio id="audio" controls class="w-full mb-4"></audio>

    <!-- Local File Upload -->
    <label class="block mb-2 font-semibold">Import dari Local Storage:</label>
    <input type="file" id="fileInput" accept="audio/*" class="w-full mb-4" />

    <!-- YouTube URL -->
    <label class="block mb-2 font-semibold">Putar dari YouTube (Embed):</label>
    <input type="text" id="ytUrl" placeholder="https://youtube.com/watch?v=..." 
           class="w-full p-2 rounded text-black mb-2" />

    <button onclick="loadYouTube()" 
            class="w-full bg-red-600 hover:bg-red-700 p-3 rounded text-lg">
      Load YouTube
    </button>

    <!-- YouTube Player -->
    <div id="ytPlayer" class="mt-4 hidden">
      <iframe id="ytFrame" 
              class="w-full h-56 rounded" 
              allow="autoplay; encrypted-media" 
              allowfullscreen>
      </iframe>
    </div>

    <!-- Link ke Riwayat -->
    <a href="/history/" 
       class="block text-center mt-4 text-blue-400 underline">
      ðŸ“‚ Lihat Riwayat Lagu
    </a>

    <p class="text-xs text-gray-400 mt-4">
      * Catatan: Audio YouTube tidak bisa diputar langsung sebagai MP3 karena batasan browser, jadi menggunakan embed.
    </p>

  </div>

  <script>
    const audio = document.getElementById("audio");
    const fileInput = document.getElementById("fileInput");

    // ===== LOCAL FILE =====
    fileInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const url = URL.createObjectURL(file);
      audio.src = url;
      audio.play();

      document.getElementById("ytPlayer").classList.add("hidden");

      const history = JSON.parse(localStorage.getItem("musicHistory") || "[]");

      history.push({
        name: file.name,
        url: url,
        type: "local",
        time: Date.now()
      });

      localStorage.setItem("musicHistory", JSON.stringify(history));
    });

    // ===== YOUTUBE =====
    function loadYouTube() {
      const url = document.getElementById("ytUrl").value;
      const videoId = extractVideoId(url);

      if (!videoId) {
        alert("URL YouTube tidak valid");
        return;
      }

      const iframe = document.getElementById("ytFrame");
      iframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1`;

      document.getElementById("ytPlayer").classList.remove("hidden");
      audio.pause();

      const history = JSON.parse(localStorage.getItem("musicHistory") || "[]");

      history.push({
        name: "YouTube: " + url,
        url: url,
        type: "youtube",
        time: Date.now()
      });

      localStorage.setItem("musicHistory", JSON.stringify(history));
    }

    function extractVideoId(url) {
      const match = url.match(/(v=|youtu.be\/|watch\?v=)([a-zA-Z0-9_-]{11})/);
      return match ? match[2] : null;
    }

    // ===== AUTO LOAD FROM HISTORY =====
    const params = new URLSearchParams(window.location.search);
    const yt = params.get("yt");

    if (yt) {
      document.getElementById("ytUrl").value = yt;
      loadYouTube();
    }
  </script>

</body>
</html>